import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:fl_chart/fl_chart.dart';
import '../../../../core/providers/auth_provider_v2.dart';
import '../../../../core/providers/repository_providers.dart';
import '../../../../data/models/upgrade_request_model.dart';
import '../../../../data/models/trip_model.dart';
import '../../../../data/models/trip_statistics.dart';
import '../../../../data/repositories/main_api_repository.dart';
import '../../../../core/utils/level_display_helper.dart';
import '../../../../shared/widgets/widgets.dart';
import '../providers/upgrade_requests_provider.dart';

/// Admin Upgrade Request Details Screen - REDESIGNED
/// 
/// Shows comprehensive member profile with trip statistics, activity chart,
/// voting panel, and comments section
class AdminUpgradeRequestDetailsScreen extends ConsumerStatefulWidget {
  final String requestId;

  const AdminUpgradeRequestDetailsScreen({
    super.key,
    required this.requestId,
  });

  @override
  ConsumerState<AdminUpgradeRequestDetailsScreen> createState() => _AdminUpgradeRequestDetailsScreenState();
}

class _AdminUpgradeRequestDetailsScreenState extends ConsumerState<AdminUpgradeRequestDetailsScreen> {
  final TextEditingController _commentController = TextEditingController();
  final TextEditingController _declineReasonController = TextEditingController();
  final _repository = MainApiRepository();
  
  // New state variables for member profile data
  List<TripListItem> _tripHistory = [];
  TripStatistics? _tripStatistics;
  bool _isLoadingTrips = false;
  bool _isLoadingStats = false;

  @override
  void dispose() {
    _commentController.dispose();
    _declineReasonController.dispose();
    super.dispose();
  }

  /// Load trip history for the member
  Future<void> _loadTripHistory(int memberId) async {
    setState(() => _isLoadingTrips = true);

    try {
      if (kDebugMode) {
        debugPrint('üöó [AdminUpgradeDetails] Fetching trip history for member $memberId...');
      }
      
      final response = await _repository.getMemberTripHistory(
        memberId: memberId,
        checkedIn: true,
        page: 1,
        pageSize: 50,  // Get more trips for better chart visualization
      );

      final List<TripListItem> trips = [];
      final data = response['data'] ?? response['results'] ?? response;
      
      if (data is List) {
        for (var item in data) {
          try {
            final trip = TripListItem.fromJson(item as Map<String, dynamic>);
            // Only include completed trips
            if (trip.status == 'completed' || DateTime.now().isAfter(trip.endTime)) {
              trips.add(trip);
            }
          } catch (e) {
            if (kDebugMode) {
              debugPrint('‚ö†Ô∏è [AdminUpgradeDetails] Error parsing trip: $e');
            }
          }
        }
      }

      // Sort by date (oldest first for chart)
      trips.sort((a, b) => a.startTime.compareTo(b.startTime));

      if (kDebugMode) {
        debugPrint('‚úÖ [AdminUpgradeDetails] Loaded ${trips.length} completed trips');
      }
      
      setState(() {
        _tripHistory = trips;
        _isLoadingTrips = false;
      });
    } catch (e) {
      if (kDebugMode) {
        debugPrint('‚ùå [AdminUpgradeDetails] Error loading trips: $e');
      }
      setState(() {
        _tripHistory = [];
        _isLoadingTrips = false;
      });
    }
  }

  /// Load trip statistics for the member
  Future<void> _loadTripStatistics(int memberId) async {
    setState(() => _isLoadingStats = true);

    try {
      debugPrint('üìä [AdminUpgradeDetails] Fetching trip statistics for member $memberId...');
      
      final response = await _repository.getMemberTripCounts(memberId);

      debugPrint('‚úÖ [AdminUpgradeDetails] Loaded trip statistics');
      debugPrint('   Raw Response: $response');
      
      // Safe extraction of data
      Map<String, dynamic> rawData;
      if (response is Map<String, dynamic>) {
        if (response.containsKey('data') && response['data'] != null) {
          rawData = response['data'] is Map<String, dynamic> 
              ? response['data'] as Map<String, dynamic>
              : Map<String, dynamic>.from(response['data'] as Map);
        } else {
          rawData = response;
        }
      } else {
        rawData = {};
      }

      final tripStats = TripStatistics.fromJson(rawData);
      
      debugPrint('   ‚úÖ Parsed Trip Statistics:');
      debugPrint('      Total: ${tripStats.totalTrips}');
      debugPrint('      Level 1: ${tripStats.level1Trips}');
      debugPrint('      Level 2: ${tripStats.level2Trips}');
      debugPrint('      Level 3: ${tripStats.level3Trips}');
      debugPrint('      Level 4: ${tripStats.level4Trips}');
      debugPrint('      Level 5: ${tripStats.level5Trips}');

      setState(() {
        _tripStatistics = tripStats;
        _isLoadingStats = false;
      });
    } catch (e, stackTrace) {
      debugPrint('‚ùå [AdminUpgradeDetails] Error loading trip statistics: $e');
      debugPrint('   Stack Trace: $stackTrace');
      
      setState(() {
        _tripStatistics = null;
        _isLoadingStats = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final colors = theme.colorScheme;
    final user = ref.watch(authProviderV2).user;
    
    // Check permissions
    final canView = user?.hasPermission('view_upgrade_req') ?? false;
    final canVote = user?.hasPermission('vote_upgrade_req') ?? false;
    final canComment = user?.hasPermission('create_comment_upgrade_req') ?? false;
    final canDeleteComment = user?.hasPermission('delete_comment_upgrade_req') ?? false;
    final canApprove = user?.hasPermission('approve_upgrade_req') ?? false;
    final canEdit = user?.hasPermission('edit_upgrade_req') ?? false;
    final canDelete = user?.hasPermission('delete_upgrade_req') ?? false;

    // Permission check
    if (!canView) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('Access Denied'),
        ),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.lock_outline, size: 64, color: colors.error),
              const SizedBox(height: 16),
              Text('Permission Required', style: theme.textTheme.headlineSmall),
              const SizedBox(height: 8),
              Text(
                'You do not have permission to view upgrade request details.',
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () => context.go('/admin/upgrade-requests'),
                child: const Text('Back to Upgrade Requests'),
              ),
            ],
          ),
        ),
      );
    }

    final requestAsync = ref.watch(upgradeRequestDetailProvider(int.parse(widget.requestId)));

    return Scaffold(
      appBar: AppBar(
        title: const Text('Upgrade Request Details'),
        actions: [
          if (canEdit)
            IconButton(
              icon: const Icon(Icons.edit),
              onPressed: () {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Edit feature coming soon')),
                );
              },
            ),
          if (canDelete)
            IconButton(
              icon: const Icon(Icons.delete),
              onPressed: () => _handleDelete(context),
            ),
        ],
      ),
      body: requestAsync.when(
        data: (request) {
          // Load member data when request loads
          if (!_isLoadingTrips && !_isLoadingStats && _tripHistory.isEmpty && _tripStatistics == null) {
            WidgetsBinding.instance.addPostFrameCallback((_) {
              _loadTripStatistics(request.member.id);
              _loadTripHistory(request.member.id);
            });
          }
          
          return _buildContent(request, canVote, canComment, canDeleteComment, canApprove, colors, theme);
        },
        loading: () => Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              CircularProgressIndicator(color: colors.primary),
              const SizedBox(height: 16),
              const Text('Loading request details...'),
            ],
          ),
        ),
        error: (error, stack) => Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.error_outline, size: 64, color: colors.error),
              const SizedBox(height: 16),
              Text('Error Loading Request', style: theme.textTheme.titleLarge),
              const SizedBox(height: 8),
              Text('$error', textAlign: TextAlign.center),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () => ref.invalidate(upgradeRequestDetailProvider(int.parse(widget.requestId))),
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildContent(
    UpgradeRequestDetail request,
    bool canVote,
    bool canComment,
    bool canDeleteComment,
    bool canApprove,
    ColorScheme colors,
    ThemeData theme,
  ) {
    return SingleChildScrollView(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1Ô∏è‚É£ ENHANCED MEMBER PROFILE HEADER
          _buildEnhancedMemberHeader(request, colors, theme),
          
          const Divider(height: 1),
          
          // 2Ô∏è‚É£ UPGRADE REQUEST SUMMARY CARD
          _buildUpgradeRequestSummary(request, colors, theme),
          
          const Divider(height: 32, thickness: 8),
          
          // 3Ô∏è‚É£ TRIP STATISTICS (Lazy loaded after scroll)
          if (_tripStatistics != null)
            _buildTripStatisticsSection(request.member.id, colors, theme),
          
          // 4Ô∏è‚É£ ACTIVITY CHART (Main feature - lazy loaded)
          if (_tripHistory.isNotEmpty)
            _buildActivityChartSection(request.member, colors, theme)
          else if (!_isLoadingTrips && _tripHistory.isEmpty && _tripStatistics != null)
            _buildNoTripsWarning(colors, theme),
          
          // 5Ô∏è‚É£ RECENT TRIPS LIST
          if (_tripHistory.isNotEmpty)
            _buildRecentTripsSection(colors, theme),
          
          const Divider(height: 32, thickness: 8),
          
          // 6Ô∏è‚É£ VOTING PANEL (Existing)
          _buildVotingPanel(request, canVote, colors, theme),
          
          const Divider(height: 32, thickness: 8),
          
          // 7Ô∏è‚É£ COMMENTS SECTION (Existing)
          _buildCommentsSection(request, canComment, canDeleteComment, colors, theme),
          
          // 8Ô∏è‚É£ ADMIN ACTIONS (Existing)
          if (request.isPending && canApprove)
            _buildAdminActions(request, colors, theme),
          
          // Approval Info (for approved/declined requests)
          if (!request.isPending && request.approvalInfo != null)
            _buildApprovalInfo(request.approvalInfo!, colors, theme),
          
          const SizedBox(height: 32),
        ],
      ),
    );
  }

  /// 1Ô∏è‚É£ ENHANCED MEMBER PROFILE HEADER
  Widget _buildEnhancedMemberHeader(UpgradeRequestDetail request, ColorScheme colors, ThemeData theme) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            colors.primary.withValues(alpha: 0.1),
            colors.surface,
          ],
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
        ),
      ),
      child: Column(
        children: [
          // Large member avatar
          CircleAvatar(
            radius: 72,  // Increased from 48px
            backgroundImage: request.member.profileImage != null
                ? NetworkImage(request.member.profileImage!)
                : null,
            child: request.member.profileImage == null
                ? Text(
                    request.member.displayName[0].toUpperCase(),
                    style: const TextStyle(fontSize: 48, fontWeight: FontWeight.bold),
                  )
                : null,
          ),
          const SizedBox(height: 16),
          
          // Member name
          Text(
            request.member.displayName,
            style: theme.textTheme.headlineMedium?.copyWith(
              fontWeight: FontWeight.bold,
            ),
            textAlign: TextAlign.center,
          ),
          
          // Member email
          if (request.member.email != null)
            Padding(
              padding: const EdgeInsets.only(top: 4),
              child: Text(
                request.member.email!,
                style: TextStyle(
                  color: colors.onSurface.withValues(alpha: 0.7),
                  fontSize: 14,
                ),
              ),
            ),
          
          const SizedBox(height: 16),
          
          // Current level badge (with icon + color from LevelDisplayHelper)
          if (request.currentLevel.isNotEmpty)
            LevelDisplayHelper.buildCompactBadgeFromString(
              levelName: request.currentLevel,
              numericLevel: _getNumericLevelFromName(request.currentLevel),
            ),
          
          // Member since date
          if (request.member.dateJoined != null && request.member.dateJoined!.isNotEmpty)
            Padding(
              padding: const EdgeInsets.only(top: 12),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.calendar_today, size: 16, color: colors.onSurface.withValues(alpha: 0.6)),
                  const SizedBox(width: 6),
                  Text(
                    'Member since ${_formatMemberSinceDate(request.member.dateJoined!)}',
                    style: TextStyle(
                      color: colors.onSurface.withValues(alpha: 0.7),
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
            ),
          
          const SizedBox(height: 24),
          
          // Stats row
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              _buildQuickStat(
                'Trips',
                '${request.member.tripCount}',
                Icons.explore,
                colors,
              ),
              Container(width: 1, height: 40, color: colors.outline),
              _buildQuickStat(
                'Member Since',
                request.member.dateJoined != null && request.member.dateJoined!.isNotEmpty
                    ? _formatMemberSinceDate(request.member.dateJoined!)
                    : 'N/A',
                Icons.calendar_today,
                colors,
              ),
              if (request.member.phoneNumber != null) ...[
                Container(width: 1, height: 40, color: colors.outline),
                _buildQuickStat(
                  'Phone',
                  'Available',
                  Icons.phone,
                  colors,
                ),
              ],
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildQuickStat(String label, String value, IconData icon, ColorScheme colors) {
    return Column(
      children: [
        Icon(icon, size: 24, color: colors.primary),
        const SizedBox(height: 4),
        Text(
          value,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
            color: colors.onSurface,
          ),
        ),
        Text(
          label,
          style: TextStyle(
            fontSize: 12,
            color: colors.onSurface.withValues(alpha: 0.6),
          ),
        ),
      ],
    );
  }

  /// 2Ô∏è‚É£ UPGRADE REQUEST SUMMARY CARD
  Widget _buildUpgradeRequestSummary(UpgradeRequestDetail request, ColorScheme colors, ThemeData theme) {
    // Status color
    Color statusColor;
    IconData statusIcon;
    
    if (request.isPending) {
      statusColor = const Color(0xFFFFA726);
      statusIcon = Icons.pending;
    } else if (request.isApproved) {
      statusColor = const Color(0xFF66BB6A);
      statusIcon = Icons.check_circle;
    } else {
      statusColor = colors.error;
      statusIcon = Icons.cancel;
    }

    return Padding(
      padding: const EdgeInsets.all(24),
      child: Card(
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
          side: BorderSide(color: statusColor.withValues(alpha: 0.3)),
        ),
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header with status
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                    decoration: BoxDecoration(
                      color: statusColor.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(statusIcon, size: 16, color: statusColor),
                        const SizedBox(width: 4),
                        Text(
                          request.status.toUpperCase(),
                          style: TextStyle(
                            color: statusColor,
                            fontSize: 12,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                  ),
                  const Spacer(),
                  Text(
                    DateFormat('MMM dd, yyyy').format(request.submittedAt),
                    style: TextStyle(
                      color: colors.onSurface.withValues(alpha: 0.6),
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
              
              const SizedBox(height: 20),
              
              // Level change visualization
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  // Current level
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: colors.surfaceContainerHighest,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        children: [
                          Text(
                            'FROM',
                            style: TextStyle(
                              fontSize: 10,
                              color: colors.onSurface.withValues(alpha: 0.6),
                              letterSpacing: 1,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            _getLevelStars(request.currentLevel),
                            style: theme.textTheme.titleLarge?.copyWith(
                              fontWeight: FontWeight.bold,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  ),
                  
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    child: Icon(
                      Icons.arrow_forward,
                      size: 28,
                      color: colors.primary,
                    ),
                  ),
                  
                  // Requested level
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: colors.primaryContainer,
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: colors.primary, width: 2),
                      ),
                      child: Column(
                        children: [
                          Text(
                            'TO',
                            style: TextStyle(
                              fontSize: 10,
                              color: colors.primary,
                              letterSpacing: 1,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            _getLevelStars(request.requestedLevel),
                            style: theme.textTheme.titleLarge?.copyWith(
                              fontWeight: FontWeight.bold,
                              color: colors.onPrimaryContainer,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
              
              const SizedBox(height: 20),
              
              // Reason section (collapsible)
              ExpansionTile(
                tilePadding: EdgeInsets.zero,
                title: Text(
                  'Reason for Upgrade',
                  style: theme.textTheme.titleSmall?.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                children: [
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: colors.surfaceContainerHighest,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text(
                      request.reason,
                      style: TextStyle(
                        fontSize: 14,
                        height: 1.5,
                        color: colors.onSurface,
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// 3Ô∏è‚É£ TRIP STATISTICS SECTION
  Widget _buildTripStatisticsSection(int memberId, ColorScheme colors, ThemeData theme) {
    if (_tripStatistics == null) {
      return const SizedBox.shrink();
    }

    final stats = _tripStatistics!;

    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Text(
            'Trip Statistics',
            style: theme.textTheme.titleLarge?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),

          // Participation Stats
          Row(
            children: [
              Expanded(
                child: _buildStatCard(
                  icon: Icons.check_circle_outline,
                  label: 'Completed',
                  value: stats.completedTrips.toString(),
                  color: Colors.green,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildStatCard(
                  icon: Icons.upcoming,
                  label: 'Upcoming',
                  value: stats.upcomingTrips.toString(),
                  color: Colors.blue,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),

          // Leadership Stats (conditional)
          if (stats.hasLeadershipExperience) ...[
            Row(
              children: [
                Expanded(
                  child: _buildStatCard(
                    icon: Icons.star,
                    label: 'As Lead',
                    value: stats.asLeadTrips.toString(),
                    color: Colors.amber,
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: _buildStatCard(
                    icon: Icons.shield,
                    label: 'As Marshal',
                    value: stats.asMarshalTrips.toString(),
                    color: Colors.purple,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
          ],

          // Level Breakdown
          Card(
            elevation: 2,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Icon(
                        Icons.bar_chart_rounded,
                        color: colors.primary,
                        size: 20,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        'Trips by Level',
                        style: theme.textTheme.titleSmall?.copyWith(
                          fontWeight: FontWeight.bold,
                          color: colors.onSurface,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  ...List.generate(5, (index) {
                    final level = index + 1;
                    final count = stats.getTripCountByLevel(level);
                    final levelLabel = LevelDisplayHelper.getTripLevelLabel(level);

                    // Map level index to numeric level for colors
                    int levelNumeric;
                    Color levelColor;
                    IconData levelIcon;

                    switch (level) {
                      case 1:
                        levelNumeric = 5; // Club Event
                        levelColor = const Color(0xFF4CAF50);
                        levelIcon = Icons.groups;
                        break;
                      case 2:
                        levelNumeric = 10; // Newbie/ANIT
                        levelColor = const Color(0xFF4CAF50);
                        levelIcon = Icons.school;
                        break;
                      case 3:
                        levelNumeric = 100; // Intermediate
                        levelColor = const Color(0xFF2196F3);
                        levelIcon = Icons.terrain;
                        break;
                      case 4:
                        levelNumeric = 200; // Advanced
                        levelColor = const Color(0xFFE91E63);
                        levelIcon = Icons.landscape;
                        break;
                      case 5:
                        levelNumeric = 300; // Expert
                        levelColor = const Color(0xFF9C27B0);
                        levelIcon = Icons.workspace_premium;
                        break;
                      default:
                        levelNumeric = 0;
                        levelColor = colors.primary;
                        levelIcon = Icons.flag;
                    }

                    return Padding(
                      padding: const EdgeInsets.only(bottom: 10),
                      child: Material(
                        color: count > 0
                            ? levelColor.withValues(alpha: 0.08)
                            : colors.surfaceContainerHighest.withValues(alpha: 0.3),
                        borderRadius: BorderRadius.circular(12),
                        child: Padding(
                          padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
                          child: Row(
                            children: [
                              // Level icon
                              Container(
                                padding: const EdgeInsets.all(6),
                                decoration: BoxDecoration(
                                  color: count > 0
                                      ? levelColor.withValues(alpha: 0.15)
                                      : colors.surfaceContainerHighest,
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: Icon(
                                  levelIcon,
                                  size: 16,
                                  color: count > 0
                                      ? levelColor
                                      : colors.onSurface.withValues(alpha: 0.4),
                                ),
                              ),
                              const SizedBox(width: 12),
                              // Level label
                              Expanded(
                                child: Text(
                                  levelLabel,
                                  style: TextStyle(
                                    fontWeight: FontWeight.w600,
                                    fontSize: 14,
                                    color: count > 0
                                        ? colors.onSurface
                                        : colors.onSurface.withValues(alpha: 0.4),
                                  ),
                                ),
                              ),
                              // Count badge
                              Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 12,
                                  vertical: 4,
                                ),
                                decoration: BoxDecoration(
                                  color: count > 0
                                      ? levelColor
                                      : colors.surfaceContainerHighest,
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Text(
                                  count.toString(),
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 14,
                                    color: count > 0
                                        ? Colors.white
                                        : colors.onSurface.withValues(alpha: 0.4),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    );
                  }),
                ],
              ),
            ),
          ),

          // Attendance Rate (conditional)
          if (stats.attendanceRate > 0) ...[
            const SizedBox(height: 12),
            Card(
              elevation: 2,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              child: Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(16),
                  gradient: LinearGradient(
                    colors: [
                      colors.primaryContainer,
                      colors.primaryContainer.withValues(alpha: 0.7),
                    ],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                ),
                padding: const EdgeInsets.all(16),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: colors.onPrimaryContainer.withValues(alpha: 0.1),
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Icon(
                            Icons.check_circle,
                            color: colors.onPrimaryContainer,
                            size: 24,
                          ),
                        ),
                        const SizedBox(width: 12),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Attendance Rate',
                              style: theme.textTheme.bodyMedium?.copyWith(
                                color: colors.onPrimaryContainer,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 2),
                            Text(
                              '${stats.checkedInCount} of ${stats.totalTrips} trips',
                              style: theme.textTheme.bodySmall?.copyWith(
                                color: colors.onPrimaryContainer.withValues(alpha: 0.7),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                    Text(
                      '${stats.attendanceRate.toStringAsFixed(1)}%',
                      style: theme.textTheme.headlineSmall?.copyWith(
                        fontWeight: FontWeight.bold,
                        color: colors.onPrimaryContainer,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ],
      ),
    );
  }

  /// 4Ô∏è‚É£ ACTIVITY CHART SECTION (Main Feature)
  Widget _buildActivityChartSection(MemberDetailInfo member, ColorScheme colors, ThemeData theme) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              Icon(Icons.show_chart, color: colors.primary, size: 24),
              const SizedBox(width: 8),
              Text(
                'Trip Activity Timeline',
                style: theme.textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            'All trips from member-since date to current',
            style: TextStyle(
              color: colors.onSurface.withValues(alpha: 0.6),
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 20),
          
          // Chart
          Card(
            elevation: 2,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: Column(
                children: [
                  // Chart widget
                  SizedBox(
                    height: 300,
                    child: _buildLineChart(member, colors),
                  ),
                  
                  const SizedBox(height: 20),
                  
                  // Legend
                  _buildChartLegend(colors, theme),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// Build line chart with fl_chart
  Widget _buildLineChart(MemberDetailInfo member, ColorScheme colors) {
    if (_tripHistory.isEmpty) {
      return const Center(child: Text('No trip data available'));
    }

    // Prepare chart data points
    final List<FlSpot> spots = [];
    final Map<int, TripListItem> spotToTripMap = {};
    
    // Use cumulative count for Y-axis
    for (int i = 0; i < _tripHistory.length; i++) {
      final trip = _tripHistory[i];
      final xValue = trip.startTime.millisecondsSinceEpoch.toDouble();
      final yValue = (i + 1).toDouble();  // Cumulative count
      
      spots.add(FlSpot(xValue, yValue));
      spotToTripMap[i] = trip;
    }

    // Get min/max dates for X-axis
    final DateTime memberSince = member.dateJoined != null && member.dateJoined!.isNotEmpty
        ? DateTime.parse(member.dateJoined!)
        : _tripHistory.first.startTime;
    final DateTime now = DateTime.now();

    return LineChart(
      LineChartData(
        minX: memberSince.millisecondsSinceEpoch.toDouble(),
        maxX: now.millisecondsSinceEpoch.toDouble(),
        minY: 0,
        maxY: (_tripHistory.length + 2).toDouble(),
        lineBarsData: [
          LineChartBarData(
            spots: spots,
            isCurved: true,
            color: colors.primary,
            barWidth: 3,
            dotData: FlDotData(
              show: true,
              getDotPainter: (spot, percent, barData, index) {
                if (index < _tripHistory.length) {
                  final trip = _tripHistory[index];
                  final levelColor = LevelDisplayHelper.getLevelColor(trip.level.numericLevel);
                  
                  return FlDotCirclePainter(
                    radius: 6,
                    color: levelColor,
                    strokeWidth: 2,
                    strokeColor: Colors.white,
                  );
                }
                return FlDotCirclePainter(
                  radius: 6,
                  color: colors.primary,
                );
              },
            ),
            belowBarData: BarAreaData(
              show: true,
              color: colors.primary.withValues(alpha: 0.1),
            ),
          ),
        ],
        titlesData: FlTitlesData(
          leftTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              reservedSize: 40,
              getTitlesWidget: (value, meta) {
                return Text(
                  value.toInt().toString(),
                  style: TextStyle(
                    color: colors.onSurface.withValues(alpha: 0.6),
                    fontSize: 12,
                  ),
                );
              },
            ),
          ),
          bottomTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              reservedSize: 30,
              getTitlesWidget: (value, meta) {
                final date = DateTime.fromMillisecondsSinceEpoch(value.toInt());
                return Padding(
                  padding: const EdgeInsets.only(top: 8),
                  child: Text(
                    DateFormat('MMM yy').format(date),
                    style: TextStyle(
                      color: colors.onSurface.withValues(alpha: 0.6),
                      fontSize: 10,
                    ),
                  ),
                );
              },
            ),
          ),
          rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
          topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
        ),
        gridData: FlGridData(
          show: true,
          drawVerticalLine: true,
          horizontalInterval: 5,
          getDrawingHorizontalLine: (value) {
            return FlLine(
              color: colors.outline.withValues(alpha: 0.2),
              strokeWidth: 1,
            );
          },
          getDrawingVerticalLine: (value) {
            return FlLine(
              color: colors.outline.withValues(alpha: 0.2),
              strokeWidth: 1,
            );
          },
        ),
        borderData: FlBorderData(
          show: true,
          border: Border.all(
            color: colors.outline.withValues(alpha: 0.3),
            width: 1,
          ),
        ),
        lineTouchData: LineTouchData(
          enabled: true,
          touchTooltipData: LineTouchTooltipData(
            getTooltipItems: (touchedSpots) {
              return touchedSpots.map((spot) {
                final index = spot.spotIndex;
                if (index < _tripHistory.length) {
                  final trip = _tripHistory[index];
                  return LineTooltipItem(
                    '${trip.title}\n${DateFormat('MMM dd, yyyy').format(trip.startTime)}\n${trip.level.displayName ?? trip.level.name}',
                    TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  );
                }
                return null;
              }).toList();
            },
          ),
        ),
      ),
    );
  }

  /// Build chart legend
  Widget _buildChartLegend(ColorScheme colors, ThemeData theme) {
    return Wrap(
      spacing: 16,
      runSpacing: 8,
      alignment: WrapAlignment.center,
      children: [
        _buildLegendItem('Club Event', LevelDisplayHelper.getLevelColor(5), theme),
        _buildLegendItem('Newbie', LevelDisplayHelper.getLevelColor(10), theme),
        _buildLegendItem('Intermediate', LevelDisplayHelper.getLevelColor(100), theme),
        _buildLegendItem('Advanced', LevelDisplayHelper.getLevelColor(200), theme),
        _buildLegendItem('Expert', LevelDisplayHelper.getLevelColor(300), theme),
      ],
    );
  }

  Widget _buildLegendItem(String label, Color color, ThemeData theme) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          width: 12,
          height: 12,
          decoration: BoxDecoration(
            color: color,
            shape: BoxShape.circle,
          ),
        ),
        const SizedBox(width: 4),
        Text(
          label,
          style: theme.textTheme.bodySmall,
        ),
      ],
    );
  }

  /// 5Ô∏è‚É£ RECENT TRIPS SECTION
  Widget _buildRecentTripsSection(ColorScheme colors, ThemeData theme) {
    // Get last 10 trips
    final recentTrips = _tripHistory.length > 10 
        ? _tripHistory.sublist(_tripHistory.length - 10)
        : _tripHistory;

    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.history, color: colors.primary, size: 24),
              const SizedBox(width: 8),
              Text(
                'Recent Trips (Last ${recentTrips.length})',
                style: theme.textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          ...recentTrips.reversed.map((trip) => Padding(
            padding: const EdgeInsets.only(bottom: 12),
            child: _buildTripCard(trip, colors, theme),
          )),
        ],
      ),
    );
  }

  Widget _buildTripCard(TripListItem trip, ColorScheme colors, ThemeData theme) {
    return Card(
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Row(
          children: [
            // Level icon
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: LevelDisplayHelper.getLevelColor(trip.level.numericLevel).withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                LevelDisplayHelper.getLevelIcon(trip.level.numericLevel),
                color: LevelDisplayHelper.getLevelColor(trip.level.numericLevel),
                size: 20,
              ),
            ),
            const SizedBox(width: 12),

            // Trip Info
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    trip.title,
                    style: theme.textTheme.titleSmall?.copyWith(
                      fontWeight: FontWeight.bold,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Row(
                    children: [
                      Icon(Icons.calendar_today, size: 12, color: colors.onSurface.withValues(alpha: 0.6)),
                      const SizedBox(width: 4),
                      Text(
                        DateFormat('MMM d, y').format(trip.startTime),
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: colors.onSurface.withValues(alpha: 0.6),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),

            // Level badge
            LevelDisplayHelper.buildCompactBadge(trip.level),
          ],
        ),
      ),
    );
  }

  /// Warning for no trips
  Widget _buildNoTripsWarning(ColorScheme colors, ThemeData theme) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Card(
        color: colors.errorContainer,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
          side: BorderSide(color: colors.error),
        ),
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Row(
            children: [
              Icon(Icons.warning, color: colors.error, size: 32),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Warning: No Trips Found',
                      style: theme.textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                        color: colors.onErrorContainer,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      'Something is wrong - this user has no trips recorded. Users must have trips to submit upgrade requests.',
                      style: theme.textTheme.bodyMedium?.copyWith(
                        color: colors.onErrorContainer,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildStatCard({
    required IconData icon,
    required String label,
    required String value,
    required Color color,
  }) {
    return Card(
      elevation: 2,
      shadowColor: color.withValues(alpha: 0.3),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient: LinearGradient(
            colors: [
              color.withValues(alpha: 0.08),
              color.withValues(alpha: 0.02),
            ],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
        ),
        padding: const EdgeInsets.symmetric(vertical: 20, horizontal: 16),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: LinearGradient(
                  colors: [
                    color.withValues(alpha: 0.2),
                    color.withValues(alpha: 0.1),
                  ],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ),
              ),
              child: Icon(icon, color: color, size: 28),
            ),
            const SizedBox(height: 12),
            Text(
              value,
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: color,
                height: 1.0,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              label,
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  // 6Ô∏è‚É£ VOTING PANEL (Keep existing implementation)
  Widget _buildVotingPanel(UpgradeRequestDetail request, bool canVote, ColorScheme colors, ThemeData theme) {
    final voteSummary = request.voteSummary;
    
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Board Votes',
            style: theme.textTheme.titleLarge?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          
          // Vote summary
          Row(
            children: [
              Expanded(
                child: _buildVoteSummaryCard(
                  'Approve',
                  voteSummary.approveCount,
                  Icons.thumb_up,
                  const Color(0xFF66BB6A),
                  colors,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: _buildVoteSummaryCard(
                  'Decline',
                  voteSummary.declineCount,
                  Icons.thumb_down,
                  colors.error,
                  colors,
                ),
              ),
            ],
          ),
          
          // Approval percentage
          if (voteSummary.totalVotes > 0)
            Padding(
              padding: const EdgeInsets.only(top: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        'Approval Rate',
                        style: TextStyle(
                          fontSize: 14,
                          color: colors.onSurface.withValues(alpha: 0.7),
                        ),
                      ),
                      Text(
                        '${voteSummary.approvalPercentage.toStringAsFixed(0)}%',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: colors.primary,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8),
                  LinearProgressIndicator(
                    value: voteSummary.approvalPercentage / 100,
                    backgroundColor: colors.surfaceContainerHighest,
                    valueColor: AlwaysStoppedAnimation<Color>(colors.primary),
                    minHeight: 8,
                    borderRadius: BorderRadius.circular(4),
                  ),
                ],
              ),
            ),
          
          // Your vote status
          if (voteSummary.currentUserVoted)
            Padding(
              padding: const EdgeInsets.only(top: 16),
              child: Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: (voteSummary.currentUserVote ?? false)
                      ? const Color(0xFF66BB6A).withValues(alpha: 0.1)
                      : colors.error.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: (voteSummary.currentUserVote ?? false)
                        ? const Color(0xFF66BB6A)
                        : colors.error,
                  ),
                ),
                child: Row(
                  children: [
                    Icon(
                      (voteSummary.currentUserVote ?? false) ? Icons.thumb_up : Icons.thumb_down,
                      size: 20,
                      color: (voteSummary.currentUserVote ?? false)
                          ? const Color(0xFF66BB6A)
                          : colors.error,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'You voted to ${(voteSummary.currentUserVote ?? false) ? "approve" : "decline"}',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: (voteSummary.currentUserVote ?? false)
                            ? const Color(0xFF66BB6A)
                            : colors.error,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          
          // Vote buttons (if can vote and pending)
          if (canVote && request.isPending)
            Padding(
              padding: const EdgeInsets.only(top: 16),
              child: Row(
                children: [
                  Expanded(
                    child: ElevatedButton.icon(
                      onPressed: () => _handleVote(true),
                      icon: const Icon(Icons.thumb_up),
                      label: const Text('Approve'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF66BB6A),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: ElevatedButton.icon(
                      onPressed: () => _handleVote(false),
                      icon: const Icon(Icons.thumb_down),
                      label: const Text('Decline'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: colors.error,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          
          // Individual votes list
          if (request.votes.isNotEmpty) ...[
            const SizedBox(height: 24),
            Text(
              'Individual Votes (${request.votes.length})',
              style: theme.textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            ...request.votes.map((vote) => _buildVoteItem(vote, colors, theme)),
          ],
        ],
      ),
    );
  }

  Widget _buildVoteSummaryCard(String label, int count, IconData icon, Color color, ColorScheme colors) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        children: [
          Icon(icon, size: 32, color: color),
          const SizedBox(height: 8),
          Text(
            '$count',
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
          Text(
            label,
            style: TextStyle(
              fontSize: 14,
              color: colors.onSurface.withValues(alpha: 0.7),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildVoteItem(Vote vote, ColorScheme colors, ThemeData theme) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          CircleAvatar(
            radius: 20,
            backgroundImage: vote.voter.profileImage != null
                ? NetworkImage(vote.voter.profileImage!)
                : null,
            child: vote.voter.profileImage == null
                ? Text(vote.voter.displayName[0].toUpperCase())
                : null,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  vote.voter.displayName,
                  style: const TextStyle(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Text(
                  DateFormat('MMM dd, yyyy - HH:mm').format(vote.votedAt),
                  style: TextStyle(
                    fontSize: 12,
                    color: colors.onSurface.withValues(alpha: 0.6),
                  ),
                ),
                if (vote.comment != null)
                  Padding(
                    padding: const EdgeInsets.only(top: 4),
                    child: Text(
                      vote.comment!,
                      style: TextStyle(
                        fontSize: 13,
                        fontStyle: FontStyle.italic,
                        color: colors.onSurface.withValues(alpha: 0.8),
                      ),
                    ),
                  ),
              ],
            ),
          ),
          Icon(
            vote.approve ? Icons.thumb_up : Icons.thumb_down,
            color: vote.approve ? const Color(0xFF66BB6A) : colors.error,
            size: 24,
          ),
        ],
      ),
    );
  }

  // 7Ô∏è‚É£ COMMENTS SECTION (Keep existing implementation)
  Widget _buildCommentsSection(
    UpgradeRequestDetail request,
    bool canComment,
    bool canDeleteComment,
    ColorScheme colors,
    ThemeData theme,
  ) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Comments (${request.comments.length})',
            style: theme.textTheme.titleLarge?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
          
          // Add comment form
          if (canComment && request.isPending)
            Padding(
              padding: const EdgeInsets.only(top: 16),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Expanded(
                    child: TextField(
                      controller: _commentController,
                      maxLines: 3,
                      decoration: InputDecoration(
                        hintText: 'Add a comment...',
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        filled: true,
                        fillColor: colors.surfaceContainerHighest,
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  IconButton.filled(
                    onPressed: _handleAddComment,
                    icon: const Icon(Icons.send),
                    style: IconButton.styleFrom(
                      backgroundColor: colors.primary,
                      foregroundColor: colors.onPrimary,
                      padding: const EdgeInsets.all(16),
                    ),
                  ),
                ],
              ),
            ),
          
          // Comments list
          if (request.comments.isEmpty)
            Padding(
              padding: const EdgeInsets.only(top: 24),
              child: Center(
                child: Column(
                  children: [
                    Icon(
                      Icons.comment_outlined,
                      size: 48,
                      color: colors.onSurface.withValues(alpha: 0.3),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'No comments yet',
                      style: TextStyle(
                        color: colors.onSurface.withValues(alpha: 0.6),
                      ),
                    ),
                  ],
                ),
              ),
            )
          else
            Padding(
              padding: const EdgeInsets.only(top: 16),
              child: Column(
                children: request.comments.map((comment) {
                  return _buildCommentItem(comment, canDeleteComment, colors, theme);
                }).toList(),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildCommentItem(UpgradeRequestComment comment, bool canDeleteComment, ColorScheme colors, ThemeData theme) {
    return Card(
      margin: const EdgeInsets.only(bottom: 12),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                CircleAvatar(
                  radius: 16,
                  backgroundImage: comment.author.profileImage != null
                      ? NetworkImage(comment.author.profileImage!)
                      : null,
                  child: comment.author.profileImage == null
                      ? Text(
                          comment.author.displayName[0].toUpperCase(),
                          style: const TextStyle(fontSize: 14),
                        )
                      : null,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        comment.author.displayName,
                        style: const TextStyle(
                          fontWeight: FontWeight.bold,
                          fontSize: 14,
                        ),
                      ),
                      Text(
                        DateFormat('MMM dd, yyyy - HH:mm').format(comment.createdAt),
                        style: TextStyle(
                          fontSize: 12,
                          color: colors.onSurface.withValues(alpha: 0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                if (comment.canDelete || canDeleteComment)
                  IconButton(
                    icon: Icon(Icons.delete_outline, color: colors.error),
                    onPressed: () => _handleDeleteComment(comment.id),
                    iconSize: 20,
                  ),
              ],
            ),
            const SizedBox(height: 12),
            Text(
              comment.text,
              style: const TextStyle(fontSize: 15, height: 1.5),
            ),
          ],
        ),
      ),
    );
  }

  // 8Ô∏è‚É£ ADMIN ACTIONS (Keep existing implementation)
  Widget _buildAdminActions(UpgradeRequestDetail request, ColorScheme colors, ThemeData theme) {
    return Container(
      margin: const EdgeInsets.all(24),
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: colors.primaryContainer.withValues(alpha: 0.3),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: colors.primary.withValues(alpha: 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.admin_panel_settings, color: colors.primary),
              const SizedBox(width: 8),
              Text(
                'Admin Actions',
                style: theme.textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: colors.primary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: () => _handleApprove(request.id),
                  icon: const Icon(Icons.check_circle),
                  label: const Text('Approve Request'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF66BB6A),
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: () => _handleDeclineDialog(request.id),
                  icon: const Icon(Icons.cancel),
                  label: const Text('Decline Request'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: colors.error,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildApprovalInfo(ApprovalInfo info, ColorScheme colors, ThemeData theme) {
    return Container(
      margin: const EdgeInsets.all(24),
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: info.isApproved
            ? const Color(0xFF66BB6A).withValues(alpha: 0.1)
            : colors.error.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: info.isApproved
              ? const Color(0xFF66BB6A)
              : colors.error,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                info.isApproved ? Icons.check_circle : Icons.cancel,
                color: info.isApproved ? const Color(0xFF66BB6A) : colors.error,
              ),
              const SizedBox(width: 8),
              Text(
                info.isApproved ? 'Approved' : 'Declined',
                style: theme.textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: info.isApproved ? const Color(0xFF66BB6A) : colors.error,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            'By: ${info.decidedBy.displayName}',
            style: const TextStyle(fontWeight: FontWeight.w500),
          ),
          Text(
            'On: ${DateFormat('MMM dd, yyyy - HH:mm').format(info.decidedAt)}',
            style: TextStyle(
              fontSize: 14,
              color: colors.onSurface.withValues(alpha: 0.7),
            ),
          ),
          if (info.reason != null) ...[
            const SizedBox(height: 12),
            Text(
              'Reason:',
              style: const TextStyle(fontWeight: FontWeight.w500),
            ),
            const SizedBox(height: 4),
            Text(
              info.reason!,
              style: TextStyle(
                fontSize: 14,
                color: colors.onSurface.withValues(alpha: 0.8),
                fontStyle: FontStyle.italic,
              ),
            ),
          ],
        ],
      ),
    );
  }

  // Helper methods
  int _getNumericLevelFromName(String levelName) {
    final cleanName = levelName.toLowerCase();
    if (cleanName.contains('club') || cleanName.contains('event')) return 5;
    if (cleanName.contains('newbie') || cleanName.contains('anit') || cleanName.contains('beginner')) return 10;
    if (cleanName.contains('intermediate')) return 100;
    if (cleanName.contains('advanced')) return 200;
    if (cleanName.contains('expert')) return 300;
    if (cleanName.contains('marshal')) return 600;
    if (cleanName.contains('board')) return 800;
    return 10; // Default to newbie
  }

  /// Get level stars emoji based on level name
  /// Uses the same logic as member_details_screen.dart
  String _getLevelStars(String levelName) {
    final cleanName = levelName.toLowerCase();
    
    // Match the logic from LevelConfigurationService.getLevelEmoji()
    if (cleanName.contains('board')) return 'üéñÔ∏è'; // Badge for Board Member
    if (cleanName.contains('marshal')) return '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'; // 5 stars
    if (cleanName.contains('expert') || cleanName.contains('explorer')) return '‚≠ê‚≠ê‚≠ê‚≠ê'; // 4 stars
    if (cleanName.contains('advanced') || cleanName.contains('advance')) return '‚≠ê‚≠ê‚≠ê'; // 3 stars
    if (cleanName.contains('intermediate')) return '‚≠ê‚≠ê'; // 2 stars
    if (cleanName.contains('anit')) return '‚≠ê'; // 1 star (same as Newbie)
    if (cleanName.contains('newbie') || cleanName.contains('beginner')) return '‚≠ê'; // 1 star
    
    return '‚≠ê'; // Default: 1 star
  }

  String _formatMemberSinceDate(String dateJoined) {
    try {
      final date = DateTime.parse(dateJoined);
      return DateFormat('MMM yyyy').format(date);
    } catch (e) {
      return dateJoined;
    }
  }

  // Action handlers (keep existing implementations)
  Future<void> _handleVote(bool approve) async {
    try {
      await ref.read(upgradeRequestActionsProvider.notifier).vote(
        requestId: int.parse(widget.requestId),
        vote: approve ? 'Y' : 'N',
      );
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Vote submitted: ${approve ? "Approve" : "Decline"}'),
            backgroundColor: approve ? const Color(0xFF66BB6A) : Theme.of(context).colorScheme.error,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to submit vote: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  Future<void> _handleAddComment() async {
    if (_commentController.text.trim().isEmpty) return;

    try {
      await ref.read(upgradeRequestActionsProvider.notifier).addComment(
        requestId: int.parse(widget.requestId),
        text: _commentController.text.trim(),
      );
      
      _commentController.clear();
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Comment added successfully'),
            backgroundColor: Color(0xFF66BB6A),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to add comment: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  Future<void> _handleDeleteComment(int commentId) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Comment'),
        content: const Text('Are you sure you want to delete this comment?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.error,
            ),
            child: const Text('Delete'),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    try {
      await ref.read(upgradeRequestActionsProvider.notifier).deleteComment(
        requestId: int.parse(widget.requestId),
        commentId: commentId,
      );
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Comment deleted')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to delete comment: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  Future<void> _handleApprove(int requestId) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Approve Upgrade Request'),
        content: const Text('Are you sure you want to approve this upgrade request? This action is final.'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF66BB6A),
            ),
            child: const Text('Approve'),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    try {
      await ref.read(upgradeRequestActionsProvider.notifier).approve(requestId);
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Request approved successfully!'),
            backgroundColor: Color(0xFF66BB6A),
          ),
        );
        
        context.go('/admin/upgrade-requests');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to approve request: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  Future<void> _handleDeclineDialog(int requestId) async {
    final result = await showDialog<String>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Decline Upgrade Request'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Text('Please provide a reason for declining this request:'),
            const SizedBox(height: 16),
            TextField(
              controller: _declineReasonController,
              maxLines: 3,
              decoration: const InputDecoration(
                hintText: 'Reason for declining...',
                border: OutlineInputBorder(),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              if (_declineReasonController.text.trim().isEmpty) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Please provide a reason')),
                );
                return;
              }
              Navigator.pop(context, _declineReasonController.text.trim());
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.error,
            ),
            child: const Text('Decline'),
          ),
        ],
      ),
    );

    if (result == null) return;

    try {
      await ref.read(upgradeRequestActionsProvider.notifier).decline(
        requestId: requestId,
        reason: result,
      );
      
      _declineReasonController.clear();
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Request declined')),
        );
        
        context.go('/admin/upgrade-requests');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to decline request: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  Future<void> _handleDelete(BuildContext context) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Upgrade Request'),
        content: const Text('Are you sure you want to delete this upgrade request? This action cannot be undone.'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.error,
            ),
            child: const Text('Delete'),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    try {
      final repository = ref.read(mainApiRepositoryProvider);
      await repository.deleteUpgradeRequest(int.parse(widget.requestId));
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Request deleted successfully')),
        );
        
        context.go('/admin/upgrade-requests');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to delete request: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }
}
